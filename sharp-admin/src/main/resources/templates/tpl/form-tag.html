<style>
    .attachment .item {
        display: inline-block;
        position: relative;
    }
</style>
<form class="needs-validation dialog-form" th:classappend="${query.readonly ? 'readonly' : ''}" th:id="${formBO.form.id}" th:name="${formBO.form.code}" th:with="col = ${(formBO.form.getAdditionalInfo() == null || formBO.form.getAdditionalInfo().get('label-col') == null) ? 2 : formBO.form.getAdditionalInfo().get('label-col')}">
    <input type="hidden" th:id="${formBO.form.code + '_id'}" th:value="${formBO.instanceId}">
    <div class="form-group row" th:each="p : ${formBO.propertyList}" th:with="isRequired = ${p.configurer.validatorProperties.get('Required.required') eq null ? false : p.configurer.validatorProperties.get('Required.required')}">
        <label th:for="${p.name}" th:class="${'col-form-label col-sm-' + col}" th:classappend="${isRequired ? 'required' : ''}" th:text="${p.configurer.label}"></label>
        <div th:class="${'col-sm-' + (12 - col)}">
            <label class="col-form-label"  th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).LABEL}" th:text="${(p.configurer.options == null || p.value == null) ? p.value : p.configurer.optionMap[p.value]}"></label>

            <input th:attr="disabled=${(p.name eq 'code' || (p.name eq 'name' && formBO.form.code eq 'sys_dict')) && formBO.instanceId != null},pattern=${p.configurer.validatorProperties.get('CustomizeRegex.regex')}" th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).TEXT}" type="text" class="form-control" th:id="${p.name}" th:name="${p.name}" th:maxlength="${p.configurer.validatorProperties.get('Length.max')}"
                   th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">

            <input th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).NUMBER_TEXT}" type="text" class="form-control" th:id="${p.name}" th:name="${p.name}" th:max="${p.configurer.validatorProperties.get('Size.max')}" th:min="${p.configurer.validatorProperties.get('Size.min')}"
                   th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}" pattern="-?\d+(\.\d+)?">

            <input th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).INTEGER_NUMBER}" type="number" class="form-control" th:id="${p.name}" th:name="${p.name}" th:max="${p.configurer.validatorProperties.get('Size.max')}" th:min="${p.configurer.validatorProperties.get('Size.min')}"
                   th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">

            <input th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).MOBILE}" type="text" class="form-control" th:id="${p.name}" th:name="${p.name}" maxlength="11" pattern="1[34578]\d{9}$"
                   th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">

            <textarea th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).TEXTAREA}" class="form-control" th:id="${p.name}" th:name="${p.name}" th:maxlength="${p.configurer.validatorProperties.get('Length.max')}"
                      th:placeholder="${p.configurer.placeholder}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}" th:text="${p.value}"></textarea>

            <select th:attr="disabled=${(p.name eq 'type' && formBO.form.code eq 'sys_dict') && formBO.instanceId != null}" th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).SELECT}" class="form-control" th:id="${p.name}" th:name="${p.name}"
                    th:placeholder="${p.configurer.placeholder}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">
                <sp:option dummyItemText th:if="${p.configurer.datasource != null}" th:attr="key=${p.configurer.datasource},group=${(p.configurer.getAdditionalInfo == null || p.configurer.getAdditionalInfo().get('group') == null) ? null : 'group'}" th:value="${p.value}"/>
            </select>

            <sp:select th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).MULTIPLE_SELECT}" th:id="${p.name}" class="form-control" th:name="${p.name}" multiple th:attr="key=${p.configurer.datasource}" th:placeholder="${p.configurer.placeholder}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}" hideDummyItemText/>

            <div th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).FILE}">
                <div class="attachment">
                    <div style="display: inline-block;">
                        <label class="btn btn-primary btn-sm btn-upload" style="margin: 2px" th:for="${p.name} + '_file'"><i class="fa fa-upload"></i> 上传</label>
                    </div>
                    <input style="display:none;" type="text" th:id="${p.name}" th:name="${p.name}" th:value="${p.value ne null ? T(com.rick.common.util.JsonUtils).toJson(p.value) : '[]'}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">
                    <input style="display: none;" type="file" multiple="multiple" th:id="${p.name} + '_file'" th:name="${p.name} + '_file'" data-group-name="attachments" th:onchange="[('window.'+ ${p.name} + '_file.ajaxFileUpload()')]" th:placeholder="${p.configurer.placeholder}">
                    <div class="attachment-items">
                        <th:block th:if="${p.value ne null}">
                            <div class="item" th:each="f : ${p.value}">
                                <a th:text="${f.fullName}" th:href="${f.url}" target="_blank"></a><button type="button" class="btn btn-link attachment_delete_btn" th:onclick="[(${'window.' + p.name + '_file.deleteAttachment('})][[${f.id}]][(', this)')]">删除</button>
                            </div>
                        </th:block>
                    </div>
                </div>
                <!--前端验证所有验证信息-->
                <div class="invalid-feedback" th:each="v : ${p.configurer.validatorList}"
                     th:text="${v.message}"></div>
            </div>

            <input th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).EMAIL}" type="email" class="form-control" th:id="${p.name}" th:name="${p.name}" th:maxlength="${p.configurer.validatorProperties.get('Length.max')}"
                   th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">

            <!--                    <input th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).DATE}" type="date" class="form-control" th:id="${p.name}" th:name="${p.name}"-->
            <!--                           th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">-->

            <input th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).DATE}" type="text" class="form-control" th:id="${p.name}" th:name="${p.name}"
                   th:placeholder="${p.configurer.placeholder}" th:value="${p.value}" th:required="${isRequired}" th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">

            <div class="form-check col-form-label" th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).CHECKBOX}" th:each="option : ${p.configurer.options}">
                <input class="form-check-input" type="checkbox" th:name="${p.name}" th:id="${option.name}" th:value="${option.name}" th:checked="${p.value ne null && #sets.contains(p.value, option.name)}" th:required="${p.configurer.options.size() eq 1 && isRequired}"
                       th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">
                <label class="form-check-label" th:for="${option.name}" th:text="${option.label}"></label>
                <th:block th:if="${p.configurer.options.size() eq 1}">
                    <!--前端验证所有验证信息-->
                    <div class="invalid-feedback" th:each="v : ${p.configurer.validatorList}"
                         th:text="${v.message}"></div>
                    <!--后端验证的错误信息-->
                    <!--                            <div class="invalid-feedback" th:if="${errors eq null ? false : (#maps.containsKey(errors, p.name) ? true : false)}" th:text="${errors.get(p.name).defaultMessage}"></div>-->
                </th:block>
            </div>

            <div class="form-check col-form-label" th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).RADIO}" th:each="option : ${p.configurer.options}">
                <input class="form-check-input" type="radio" th:name="${p.name}" th:id="${option.name}" th:value="${option.name}" th:checked="${option.name eq p.value}"
                       th:classappend="${errors eq null ? '' : (#maps.containsKey(errors, p.name) ? 'is-invalid' : 'is-valid')}">
                <label class="form-check-label" th:for="${option.name}" th:text="${option.label}"></label>
            </div>

            <div th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).SWITCH}">
                <label class="col-form-label switch switch-pill switch-primary">
                    <input class="switch-input" type="checkbox" th:name="${p.name}" th:checked="${'1' eq p.value}">
                    <span class="switch-slider"></span>
                </label>
            </div>
            <table th:class="${p.name + ' table'}"
                   th:if="${p.configurer.cpnType == T(com.rick.formflow.form.cpn.core.CpnTypeEnum).TABLE}" th:id="${p.name}" th:name="${p.name}">
                <thead>
                <tr>
                    <th th:each="c : ${p.configurer.getAdditionalInfo().get('columns')}"
                        th:with="isRequired = ${c.validatorProperties.get('Required.required') eq null ? false : c.validatorProperties.get('Required.required')}">
                        <label class="col-form-label" th:classappend="${isRequired ? 'required' : ''}" th:text="${c.label}"></label>
                    </th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="row : ${p.value}">
                    <td th:each="col: ${row}">
                        <input type="text" class="form-control" th:value="${col}">
                    </td>
                    <td class="operator btn-link">X</td>
                </tr>
                </tbody>
            </table>

            <th:block th:if="${p.configurer.cpnType ne T(com.rick.formflow.form.cpn.core.CpnTypeEnum).CHECKBOX &&
                p.configurer.cpnType ne T(com.rick.formflow.form.cpn.core.CpnTypeEnum).FILE}">
                <!--前端验证所有验证信息-->
                <div class="invalid-feedback" th:each="v : ${p.configurer.validatorList}"
                     th:text="${v.message}"></div>
                <!--后端验证的错误信息-->
                <!--                        <div class="invalid-feedback" th:if="${errors eq null ? false : (#maps.containsKey(errors, p.name) ? true : false)}" th:text="${errors.get(p.name).defaultMessage}"></div>-->
            </th:block>
        </div>
    </div>
    <div class="form-group row" th:if="${(formBO.form.getAdditionalInfo() == null || formBO.form.getAdditionalInfo().get('showSaveFormBtn') == null || formBO.form.getAdditionalInfo().get('showSaveFormBtn') == true)}">
        <label th:class="${'col-form-label col-sm-' + col}"></label>
        <div th:class="${'col-sm-' + (12 - col)}">
            <button type="button" class="btn btn-primary btn-save">保存</button>
        </div>
    </div>
</form>
<script src="/coreui/vendors/jquery/js/jquery.min.js"></script>
<script src="/js/form-support.js"></script>
<script th:inline="javascript">
    $(function () {
        ;(function () {
            let originalFormData = /*[[${ formBO.data }]]*/
                let formCode = /*[[${formBO.form.code}]]*/
                console.log("formCode = ", formCode)

            $.fn.multipleSelect.locales['zh-CN'] = {
                formatSelectAll: function () {
                    return '[全选]'
                },
                formatAllSelected: function () {
                    return '已选择所有记录'
                },
                formatCountSelected: function(count, total) {
                    return '已从' + total + '条记录中选择' + count + '条'
                },
                formatNoMatchesFound: function () {
                    return '没有找到记录'
                }
            }

            $.extend($.fn.multipleSelect.defaults, $.fn.multipleSelect.locales['zh-CN'])

            let id = formCode + '_id'
            window[formCode + 'FormDOM'] = document.getElementById(/*[[${formBO.form.id} + '']]*/);
            let idDOM = document.getElementById(id)
            window['$' + formCode + 'FormDOM'] = $(window[formCode + 'FormDOM'])
            window[id] = idDOM

            let readonly = [[${query.readonly}]]
            if (readonly) {
                window['$' + formCode + 'FormDOM'].find('.table .operator').hide()
                window['$' + formCode + 'FormDOM'].find(':input').prop("disabled", true);
                // window['$' + formCode + 'FormDOM'].find('.btn-save').hide()
            }

            registerValid(window[formCode + 'FormDOM']);

            window[formCode + 'FormData'] = function () {
                let formData = window['$' + formCode + 'FormDOM'].form2json({
                    multiValSelector: '[type=checkbox]'
                });

                formData.id = formData[formCode + '_id']
                console.log(formData)
                return formData
            }
            window[formCode + 'SaveForm'] = (successCallback) => {
                if (!window[formCode + 'FormDOM'].valid()) {
                    return
                }
                let formData = window[formCode + 'FormData']()

                $.ajax({
                    url: "/forms/ajax/" + "[(${formBO.actionUrl})]",
                    type: "[(${formBO.method})]",
                    data: JSON.stringify(formData),
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function(res){
                        window[formCode + '_id'].value = res.data
                        if (successCallback) {
                            successCallback && successCallback(res)
                        } else {
                            if (!res.success) {
                                toastr.error(res.message)
                            } else {
                                idDOM.value = originalFormData.id = res.data
                                if (/*[[${reloadTab}]]*/) {
                                    reloadTab(/*[[${reloadTab}]]*/)
                                }
                                toastr.success("保存成功")
                            }

                        }
                    }
                });
            }

            window['$' + formCode + 'FormDOM'].find('.btn-save').on('click', function () {
                window[formCode + 'SaveForm']()
            })

            let p = [[${formBO.propertyList}]]

            let tables = p.filter(c => c.configurer.cpnType == 'TABLE')
            tables.forEach(c => {
                $('.' + c.name).editableTable({
                    columns: c.configurer.additionalInfo.columns.length
                })
            })

            let dates = p.filter(c => c.configurer.cpnType == 'DATE')
            dates.forEach(c => {
                $('#'+c.name).datepicker({
                    language: "zh-CN",
                    autoclose: true,
                    clearBtn: true,
                    todayBtn: 'linked',
                    todayHighlight: true,
                    format: 'yyyy-mm-dd'
                })
            })

            var multipleSelect = p.filter(c => c.configurer.cpnType == 'MULTIPLE_SELECT')
            multipleSelect.forEach(c => {
                $('#' + c.name).multipleSelect({
                    selectAll: true,
                    single: false,
                    placeholder: c.configurer.placeholder
                }).multipleSelect('setSelects',  originalFormData[c.name] || [])
            })

            // file
            let files = p.filter(c => c.configurer.cpnType == 'FILE')
            files.forEach(c => {
                debugger
                window[c.name + '_file'] = new FileUpload(c.name + '_file')
            })

        })()
    })
</script>
